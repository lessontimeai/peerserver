<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .scrollbar-custom::-webkit-scrollbar { width: 6px; }
        .scrollbar-custom::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-custom::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .scrollbar-custom::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen font-sans overflow-hidden selection:bg-blue-500 selection:text-white">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="fixed inset-0 z-50 bg-gray-900 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/30">
                    <i class="fas fa-comments text-2xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold">Join Chat Room</h1>
                <p class="text-gray-400 text-sm mt-2">Secure, P2P, Ephemeral.</p>
            </div>
            <form onsubmit="app.join(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Username</label>
                    <input type="text" id="usernameInput" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition" placeholder="e.g. Alex" required autocomplete="off">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1">Room ID</label>
                    <input type="text" id="roomInput" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition" placeholder="e.g. dev-team" required autocomplete="off">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-lg transition transform active:scale-95 shadow-lg">
                    Join Room
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="mainApp" class="hidden flex h-full">
        
        <!-- SIDEBAR (User List) -->
        <div class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col hidden md:flex">
            <div class="p-4 border-b border-gray-700">
                <h2 class="font-bold text-gray-200 flex items-center gap-2">
                    <i class="fas fa-users text-blue-400"></i> Online Users
                    <span id="userCount" class="bg-gray-700 text-xs px-2 py-0.5 rounded-full text-gray-300">1</span>
                </h2>
            </div>
            <div id="userList" class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-custom">
                <!-- User items injected here -->
            </div>
            <div class="p-4 border-t border-gray-700 bg-gray-800/50">
                <div class="text-xs text-gray-500 mb-1">Your ID</div>
                <div class="flex items-center justify-between bg-gray-900 rounded p-2 border border-gray-700">
                    <span id="myDisplayId" class="text-xs font-mono text-gray-300 truncate w-24">...</span>
                    <button onclick="app.copyId()" class="text-gray-400 hover:text-white"><i class="far fa-copy"></i></button>
                </div>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="flex-1 flex flex-col min-w-0 bg-gray-900">
            
            <!-- Chat Header -->
            <header class="h-16 bg-gray-800/80 backdrop-blur border-b border-gray-700 flex items-center justify-between px-4 sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <button class="md:hidden text-gray-400 hover:text-white" onclick="app.toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1 class="font-bold text-lg flex items-center gap-2">
                            # <span id="roomTitle">general</span>
                        </h1>
                        <div class="text-xs text-green-400 flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Connected
                        </div>
                    </div>
                </div>
                <button onclick="app.leave()" class="text-red-400 hover:text-red-300 hover:bg-red-400/10 px-3 py-1.5 rounded text-sm transition">
                    <i class="fas fa-sign-out-alt mr-1"></i> Leave
                </button>
            </header>

            <!-- Messages List -->
            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-custom flex flex-col">
                <div class="text-center text-gray-600 text-sm py-4">
                    Welcome to the start of the <span class="font-mono text-blue-500">#<span id="welcomeRoomName">room</span></span>.
                    <br>Messages are P2P and not saved on any server.
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-gray-800/50 border-t border-gray-700">
                <form onsubmit="app.sendMessage(event)" class="max-w-4xl mx-auto relative flex items-center gap-2">
                    <input type="text" id="msgInput" class="flex-1 bg-gray-700 border-0 text-white rounded-full px-5 py-3 focus:ring-2 focus:ring-blue-500 focus:bg-gray-600 transition placeholder-gray-400" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center transition shadow-lg transform active:scale-90">
                        <i class="fas fa-paper-plane text-sm"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div id="mobileSidebar" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="app.toggleSidebar()"></div>
        <div class="absolute left-0 top-0 bottom-0 w-64 bg-gray-800 border-r border-gray-700 flex flex-col transform transition-transform duration-300 translate-x-0">
             <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="font-bold">Users</h2>
                <button onclick="app.toggleSidebar()"><i class="fas fa-times"></i></button>
            </div>
            <div id="mobileUserList" class="p-2 space-y-1"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
    <script src="peerclient.js"></script>
    <script>
        const app = {
            peerClient: null,
            username: '',
            roomId: '',
            isSidebarOpen: false,

            ui: {
                loginScreen: document.getElementById('loginScreen'),
                mainApp: document.getElementById('mainApp'),
                usernameInput: document.getElementById('usernameInput'),
                roomInput: document.getElementById('roomInput'),
                userList: document.getElementById('userList'),
                mobileUserList: document.getElementById('mobileUserList'),
                messages: document.getElementById('messages'),
                msgInput: document.getElementById('msgInput'),
                myDisplayId: document.getElementById('myDisplayId'),
                userCount: document.getElementById('userCount'),
                roomTitle: document.getElementById('roomTitle'),
                welcomeRoomName: document.getElementById('welcomeRoomName'),
                mobileSidebar: document.getElementById('mobileSidebar'),
            },

            async join(event) {
                event.preventDefault();
                this.username = this.ui.usernameInput.value.trim();
                this.roomId = this.ui.roomInput.value.trim();

                if (!this.username || !this.roomId) {
                    alert('Username and Room ID are required.');
                    return;
                }

                // --- Use peerserver.js for signaling, not a separate server ---
                const SIGNALING_SERVER_URL = `http://localhost:1444`; // The main http server
                this.peerClient = new PeerClient(SIGNALING_SERVER_URL, '/peers', 'peerjs');
                
                this.setupPeerClientCallbacks();

                try {
                    const peerId = await this.peerClient.initialize(this.roomId);
                    this.ui.myDisplayId.textContent = this.getShortId(peerId);
                    this.ui.roomTitle.textContent = this.roomId;
                    this.ui.welcomeRoomName.textContent = this.roomId;

                    this.ui.loginScreen.classList.add('hidden');
                    this.ui.mainApp.classList.remove('hidden');
                    this.ui.msgInput.focus();
                } catch (err) {
                    console.error("Initialization failed:", err);
                    alert(`Error: ${err.message || err.type}. Could not connect to the server.`);
                }
            },
            
            setupPeerClientCallbacks() {
                this.peerClient.onPeerListUpdate = (peers) => {
                    this.updateUserList(peers);
                };

                this.peerClient.onChatMessage = (data) => {
                    this.addMessage(data);
                };

                this.peerClient.onStatusChange = (status) => {
                    console.log("Status:", status);
                };
            },

            updateUserList(peerIds) {
                const fullPeerList = [this.peerClient.myPeerId, ...peerIds.filter(id => id !== this.peerClient.myPeerId)];
                this.ui.userCount.textContent = fullPeerList.length;
                
                const userHtml = fullPeerList.map(peerId => {
                    const isMe = peerId === this.peerClient.myPeerId;
                    return `
                        <div class="flex items-center gap-3 p-2 rounded-md ${isMe ? 'bg-blue-600/20' : ''}">
                            <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-sm font-bold">${this.getShortId(peerId).substring(0, 2)}</div>
                            <div class="flex-1">
                                <p class="text-sm font-semibold truncate">${this.getShortId(peerId)} ${isMe ? '<span class="text-xs text-gray-400">(You)</span>' : ''}</p>
                            </div>
                        </div>
                    `;
                }).join('');

                this.ui.userList.innerHTML = userHtml;
                this.ui.mobileUserList.innerHTML = userHtml;
            },

            addMessage({ body, isLocal = false, sender = 'Anonymous' }) {
                const messageDiv = document.createElement('div');
                const senderName = isLocal ? this.username : sender;
                const alignClass = isLocal ? 'justify-end' : 'justify-start';
                const bubbleColor = isLocal ? 'bg-blue-600' : 'bg-gray-700';
                
                messageDiv.className = `flex ${alignClass} fade-in`;
                messageDiv.innerHTML = `
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${bubbleColor}">
                        ${!isLocal ? `<div class="text-xs font-bold text-blue-300 mb-1">${senderName}</div>` : ''}
                        <p class="text-sm">${this.escapeHTML(body)}</p>
                    </div>
                `;
                this.ui.messages.appendChild(messageDiv);
                this.ui.messages.scrollTop = this.ui.messages.scrollHeight;
            },

            sendMessage(event) {
                event.preventDefault();
                const msg = this.ui.msgInput.value.trim();
                if (msg && this.peerClient) {
                    this.peerClient.sendMessage(msg, { sender: this.username });
                    this.ui.msgInput.value = '';
                }
            },

            leave() {
                if (this.peerClient) {
                    this.peerClient.disconnect();
                }
                this.ui.mainApp.classList.add('hidden');
                this.ui.loginScreen.classList.remove('hidden');
                this.resetUI();
            },
            
            resetUI() {
                this.ui.userList.innerHTML = '';
                this.ui.mobileUserList.innerHTML = '';
                this.ui.messages.innerHTML = '';
                this.ui.msgInput.value = '';
            },

            copyId() {
                if(this.peerClient && this.peerClient.myPeerId) {
                    navigator.clipboard.writeText(this.peerClient.myPeerId)
                        .then(() => alert('Your Peer ID has been copied!'))
                        .catch(err => console.error('Failed to copy ID: ', err));
                }
            },

            toggleSidebar() {
                this.isSidebarOpen = !this.isSidebarOpen;
                if (this.isSidebarOpen) {
                    this.ui.mobileSidebar.classList.remove('hidden');
                    // Add class to trigger animation
                } else {
                    this.ui.mobileSidebar.classList.add('hidden');
                }
            },

            getShortId(id) {
                return id ? `...${id.slice(-6)}` : '...';
            },

            escapeHTML(str) {
                const p = document.createElement('p');
                p.appendChild(document.createTextNode(str));
                return p.innerHTML;
            }
        };

        // Auto-fill room from URL query param for easier testing
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const room = urlParams.get('room');
            if (room) {
                app.ui.roomInput.value = room;
            }
        });
    </script>
</body>
</html>